# GuluCoding 技术架构设计文档 V2.0
**Technical Architecture Design Document**

---

## 文档元数据
- **版本**: V2.0 (Production-Ready Architecture)
- **目标读者**: CTO、技术负责人、全栈工程师、架构师
- **最后更新**: 2024-12
- **状态**: 🟢 待评审 (Pending Review)

---

## 执行摘要 (Executive Summary)

### 核心问题
当前 MVP 是一个 **1000+ 行单体前端应用**，所有教学逻辑硬编码在 `GameCanvas.tsx` 中。这导致：
- ❌ 内容团队无法独立工作（每个新关卡需要工程师介入）
- ❌ 无法热更新（改个文案要重新发版）
- ❌ 扩展成本高（新增数学/英语学科需要重写整套逻辑）
- ❌ 测试困难（无法单独调试某个关卡）

### 解决方案
采用 **"内容工厂模式"（Content Factory Pattern）**：
1. **引擎层（Engine）**：通用的游戏状态机，由工程师维护
2. **内容层（Content）**：JSON 配置文件，由教研团队 + AI 生产
3. **基础设施层（Infrastructure）**：Next.js + Supabase，支持数据持久化与全球化部署

### 预期收益
- ✅ 内容生产效率提升 **500%**（AI 辅助生成 JSON）
- ✅ 发布周期从 **2 周缩短至 2 小时**（热更新）
- ✅ 支持横向扩科（数学、英语共用同一套引擎）
- ✅ 为 ToB 企业版打下基础（多租户、权限管理）

---

## 1. 现状诊断 (Current State Analysis)

### 1.1 当前技术栈
```
前端框架:    React 18 (Vite)
样式方案:    Tailwind CSS (CDN)
状态管理:    本地 useState/useEffect
数据存储:    内存（刷新即丢失）
AI 集成:     Gemini API (前端直连，Key 暴露)
部署方式:    静态托管 (Vercel/Netlify)
```

### 1.2 关键代码模块分析

#### 核心文件结构
```
/
├── App.tsx                    # 路由 + 全局状态 (200 行)
├── problemData.ts             # 静态数据库 (300 行)
├── components/
│   ├── GameCanvas.tsx         # 🔴 单体巨石 (1200+ 行)
│   ├── Visualizer.tsx         # 专业模式 (400 行)
│   ├── ESLPanel.tsx           # 英语模块 (500 行)
│   └── CodeDisplay.tsx        # 代码高亮 (150 行)
└── services/
    └── geminiService.ts       # AI 调用 (100 行)
```

#### GameCanvas.tsx 的典型代码模式
```typescript
// 🔴 问题：硬编码的条件分支
if (problem.id === 'SWAP') {
  return renderSwapGame();
} else if (problem.id === 'FIND_MAX') {
  return renderFindMaxGame();
} else if (problem.id === 'SORT_3') {
  return renderSortGame();
}

// 每个渲染函数内部又有大量的状态管理
const renderSwapGame = () => {
  const [phase, setPhase] = useState('DECLARE');
  const [localValues, setLocalValues] = useState({...});
  // ... 200 行逻辑
}
```

### 1.3 核心痛点矩阵

| 维度 | 当前状态 | 影响 | 优先级 |
|------|----------|------|--------|
| **内容耦合** | 逻辑写在代码里 | 内容团队被阻塞 | 🔴 P0 |
| **数据持久化** | 无后端，无数据库 | 用户进度丢失，无法变现 | 🔴 P0 |
| **API 安全** | Key 暴露在前端 | 被盗用风险，资损隐患 | 🟡 P1 |
| **扩展性** | 单体组件 | 新增关卡成本高 | 🟡 P1 |
| **测试性** | 无单元测试 | Bug 多，迭代慢 | 🟢 P2 |

---

## 2. 目标架构设计 (Target Architecture)

### 2.1 总体架构图

```mermaid
graph TB
    subgraph "用户层 (User Layer)"
        WebApp[Web App<br/>Next.js + React]
        MobileApp[移动端 H5<br/>PWA]
    end

    subgraph "应用层 (Application Layer)"
        GameEngine[通用游戏引擎<br/>GameEngine.tsx]
        ContentLoader[内容加载器<br/>ContentLoader.ts]
        AuthModule[认证模块<br/>Auth.ts]
    end

    subgraph "内容层 (Content Layer)"
        LevelDB[(关卡数据库<br/>PostgreSQL JSONB)]
        AssetCDN[静态资源<br/>CDN]
        ContentCMS[内容管理后台<br/>Strapi/自研]
    end

    subgraph "服务层 (Service Layer)"
        APIGateway[API 网关<br/>Next.js API Routes]
        AIProxy[AI 代理<br/>Gemini/通义千问]
        CodeRunner[代码沙盒<br/>Judge0]
    end

    subgraph "基础设施层 (Infrastructure)"
        Supabase[(Supabase<br/>Auth + DB + Storage)]
        CloudFlare[CloudFlare<br/>CDN + DDoS]
        Monitoring[监控告警<br/>Sentry + Posthog]
    end

    WebApp --> GameEngine
    MobileApp --> GameEngine
    GameEngine --> ContentLoader
    GameEngine --> AuthModule
    ContentLoader --> APIGateway
    APIGateway --> LevelDB
    APIGateway --> AIProxy
    APIGateway --> CodeRunner
    AuthModule --> Supabase
    LevelDB --> Supabase
    AssetCDN --> CloudFlare
    ContentCMS --> LevelDB

    style GameEngine fill:#60a5fa
    style LevelDB fill:#34d399
    style AIProxy fill:#fbbf24
```

### 2.2 核心架构原则

#### 原则 1: 产研解耦 (Decoupling)
- **引擎层**只关心"如何执行"（渲染元素、处理交互、触发动画）
- **内容层**只关心"执行什么"（关卡规则、初始值、验证逻辑）
- 两者通过标准化的 **JSON Schema** 通信

#### 原则 2: 数据驱动 (Data-Driven)
```javascript
// 旧模式：代码驱动
if (problem.id === 'SWAP') {
  // 200 行硬编码逻辑
}

// 新模式：数据驱动
const level = await fetchLevel('swap');
<GameEngine config={level} />
```

#### 原则 3: 渐进式迁移 (Strangler Fig)
- ✅ 保留现有路由 `/play/swap`（旧引擎）
- ✅ 新建实验路由 `/lab/engine`（新引擎）
- ✅ 逐个关卡迁移，双轨运行
- ✅ 验证稳定后切换流量

---

## 3. 技术选型对比 (Technology Stack Comparison)

### 3.1 前端框架选型

| 方案 | 优点 | 缺点 | 评分 |
|------|------|------|------|
| **Next.js 14 (App Router)** ✅ | • SSR 支持 SEO<br>• 内置 API Routes<br>• Vercel 全球 CDN<br>• TypeScript 原生支持 | • 学习曲线（从 Vite 迁移）<br>• 构建时间略长 | ⭐⭐⭐⭐⭐ |
| **继续使用 Vite** | • 已有代码可复用<br>• 构建速度快 | • 无 SSR（SEO 差）<br>• 需要自建后端 | ⭐⭐⭐ |
| **Remix** | • 数据加载优雅<br>• Web 标准 | • 社区较小<br>• 文档不如 Next.js | ⭐⭐⭐ |

**✅ 推荐：Next.js 14**
- 理由：业界标准，Vercel 部署零配置，SEO 友好，便于后续 ToB 多租户改造

### 3.2 后端架构选型

| 方案 | 优点 | 缺点 | 评分 |
|------|------|------|------|
| **Supabase (自托管)** ✅ | • 开源，可部署到阿里云<br>• PostgreSQL（JSONB 支持好）<br>• 内置 Auth/Storage/Realtime | • 需要运维（自托管模式）<br>• 中国区网络优化需配置 | ⭐⭐⭐⭐⭐ |
| **Firebase** | • Google 官方<br>• 文档完善 | • 🔴 中国大陆不可用<br>• Firestore 查询限制多 | ⭐⭐ |
| **传统后端 (Express + MySQL)** | • 完全可控 | • 开发成本高<br>• 需要从零搭建 Auth | ⭐⭐⭐ |

**✅ 推荐：Supabase（国际版用 Cloud，中国版自托管）**

### 3.3 AI 服务路由策略

```typescript
// services/aiRouter.ts
export async function callAI(prompt: string, userRegion: string) {
  if (userRegion === 'CN') {
    return await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
      // 阿里云通义千问
    });
  } else {
    return await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-pro', {
      // Google Gemini
    });
  }
}
```

---

## 4. 数据模型设计 (Database Schema)

### 4.1 核心表结构

#### 表 1: `levels` (关卡内容表)
```sql
CREATE TABLE levels (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,              -- 如 'swap', 'find_max'
  config JSONB NOT NULL,                  -- 核心：存储完整的关卡配置
  version INT DEFAULT 1,                  -- 版本控制
  status TEXT DEFAULT 'draft',            -- draft/published/archived
  subject TEXT DEFAULT 'coding',          -- coding/math/esl
  difficulty INT DEFAULT 1,               -- 1-10
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引优化
CREATE INDEX idx_levels_slug ON levels(slug);
CREATE INDEX idx_levels_subject ON levels(subject);
```

#### 表 2: `user_progress` (学习进度表)
```sql
CREATE TABLE user_progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  level_id UUID REFERENCES levels(id),
  status TEXT DEFAULT 'locked',           -- locked/active/completed
  stars INT DEFAULT 0,                    -- 0-3 星评价
  attempts INT DEFAULT 0,                 -- 尝试次数
  best_time INT,                          -- 最佳通关时间（秒）
  last_played_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  UNIQUE(user_id, level_id)
);
```

#### 表 3: `user_profiles` (用户档案表)
```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  display_name TEXT,
  avatar_url TEXT,
  subscription_tier TEXT DEFAULT 'free', -- free/pro/enterprise
  language TEXT DEFAULT 'en',            -- en/cn
  region TEXT,                           -- 用于 AI 路由
  total_stars INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.2 关卡配置 Schema (JSONB)

```json
{
  "id": "swap",
  "meta": {
    "title": {
      "en": "Swap Two Variables",
      "cn": "交换两个变量"
    },
    "description": {
      "en": "Learn the classic swap algorithm",
      "cn": "学习经典的交换算法"
    },
    "estimatedTime": 300,
    "tags": ["beginner", "algorithm"]
  },
  "layout": {
    "background": "#0f172a",
    "elements": [
      {
        "id": "box_a",
        "type": "variable_box",
        "position": { "x": 150, "y": 250 },
        "initialValue": 10,
        "style": { "color": "#3b82f6" }
      },
      {
        "id": "box_b",
        "type": "variable_box",
        "position": { "x": 450, "y": 250 },
        "initialValue": 20,
        "style": { "color": "#ef4444" }
      }
    ]
  },
  "logic": {
    "steps": [
      {
        "id": 1,
        "instruction": {
          "en": "Declare a temporary variable",
          "cn": "声明一个临时变量"
        },
        "trigger": {
          "type": "button_click",
          "target": "btn_declare"
        },
        "action": {
          "type": "spawn_element",
          "element": {
            "id": "temp",
            "type": "variable_box",
            "position": { "x": 300, "y": 100 },
            "initialValue": null,
            "style": { "color": "#10b981" }
          }
        },
        "validation": null,
        "onSuccess": {
          "sound": "ding",
          "nextStep": 2
        }
      },
      {
        "id": 2,
        "instruction": {
          "en": "Drag 'a' to 'temp' to save it",
          "cn": "把 'a' 拖到 'temp' 保存"
        },
        "trigger": {
          "type": "drag_drop",
          "source": "box_a",
          "target": "temp"
        },
        "validation": {
          "rule": "target.id === 'temp'",
          "errorMessage": {
            "en": "You must drag to temp!",
            "cn": "你必须拖到 temp！"
          }
        },
        "action": {
          "type": "copy_value",
          "from": "box_a",
          "to": "temp"
        },
        "onSuccess": {
          "sound": "ding",
          "nextStep": 3
        }
      }
      // ... 后续步骤
    ]
  },
  "code": {
    "cpp": [
      "int a = 10;",
      "int b = 20;",
      "int temp;",
      "temp = a;",
      "a = b;",
      "b = temp;"
    ]
  }
}
```

---

## 5. 迁移路径 (Migration Roadmap)

### 5.1 阶段一：基础设施搭建 (Week 1-2)

**目标**：完成 Next.js 项目初始化，不破坏现有功能

**任务清单**：
- [ ] 创建 Next.js 项目 (`npx create-next-app@latest`)
- [ ] 迁移现有组件到 `app/components/legacy/`
- [ ] 配置 Tailwind CSS
- [ ] 设置 TypeScript 严格模式
- [ ] 配置 ESLint + Prettier
- [ ] 部署到 Vercel（预览环境）

**验收标准**：
- ✅ 旧版 MVP 在 `/legacy` 路由下完全可用
- ✅ 构建无报错
- ✅ Vercel 部署成功

### 5.2 阶段二：数据库与认证 (Week 3-4)

**目标**：接入 Supabase，实现用户登录与进度保存

**任务清单**：
- [ ] 注册 Supabase 项目
- [ ] 创建数据库表 (levels, user_progress, user_profiles)
- [ ] 集成 Supabase Auth (Email + Google OAuth)
- [ ] 实现用户注册/登录 UI
- [ ] 实现进度保存 API (`/api/progress`)

**验收标准**：
- ✅ 用户可以注册并登录
- ✅ 完成关卡后进度写入数据库
- ✅ 刷新页面后进度不丢失

### 5.3 阶段三：通用引擎开发 (Week 5-7)

**目标**：开发 JSON 驱动的 GameEngine

**任务清单**：
- [ ] 定义 `GuluLevelSchema` TypeScript 类型
- [ ] 实现 `GameEngine.tsx` 核心状态机
- [ ] 实现通用渲染器 (`RenderLayer.tsx`)
- [ ] 实现拖拽事件处理器（兼容移动端）
- [ ] 实现验证规则引擎 (`ValidationEngine.ts`)
- [ ] 创建沙盒页面 `/lab/engine`

**验收标准**：
- ✅ 用 JSON 配置文件成功渲染 SWAP 关卡
- ✅ 拖拽交互正常，验证逻辑生效
- ✅ 移动端（iPad）测试通过

### 5.4 阶段四：内容迁移 (Week 8-10)

**目标**：将现有 4 个关卡迁移到新引擎

**任务清单**：
- [ ] 将 `ASSIGNMENT` 转为 JSON
- [ ] 将 `SWAP` 转为 JSON
- [ ] 将 `FIND_MAX` 转为 JSON
- [ ] 将 `SORT_3` 转为 JSON
- [ ] 教研团队培训（如何编辑 JSON）
- [ ] 编写 JSON 校验工具

**验收标准**：
- ✅ 4 个关卡在新引擎下表现一致
- ✅ 教研团队能独立修改 JSON 并预览

### 5.5 阶段五：AI 与支付集成 (Week 11-12)

**目标**：完成商业化闭环

**任务清单**：
- [ ] 实现 AI 后端代理（隐藏 API Key）
- [ ] 接入 Stripe 支付（国际版）
- [ ] 接入微信支付（中国版）
- [ ] 实现订阅管理 Dashboard
- [ ] 配置 Sentry 错误监控

**验收标准**：
- ✅ AI 调用从后端发起，前端无 Key 暴露
- ✅ 用户可以购买 Pro 订阅
- ✅ 付费后解锁高级功能

---

## 6. 风险评估与应对 (Risk Management)

### 高风险项

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| **旧代码迁移失败** | 🟡 中 | 🔴 高 | 采用绞杀榕模式，双轨运行 |
| **教研团队无法适应 JSON** | 🟡 中 | 🟡 中 | 开发可视化编辑器，降低门槛 |
| **性能下降（JSON 解析开销）** | 🟢 低 | 🟡 中 | 使用 JSONB 索引，启用 CDN 缓存 |
| **Supabase 自托管运维** | 🟡 中 | 🟡 中 | 优先使用 Cloud 版本，中国区单独部署 |

---

## 7. 成功指标 (Success Metrics)

### 技术指标
- **代码复用率**：新学科（数学/英语）使用同一引擎，代码复用 > 80%
- **构建速度**：从提交到部署 < 5 分钟
- **API 响应时间**：P95 < 200ms

### 业务指标
- **内容生产效率**：单个关卡开发时间从 2 天降至 2 小时
- **发布频率**：从月更新到日更新
- **用户留存**：7 日留存率 > 40%（有了进度保存）

---

## 8. 附录：快速启动指南

### 本地开发环境搭建

```bash
# 1. 克隆仓库
git clone https://github.com/your-org/gulucoding-v2.git
cd gulucoding-v2

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp .env.example .env.local
# 编辑 .env.local，填入 Supabase URL 和 API Key

# 4. 启动开发服务器
npm run dev

# 5. 访问 http://localhost:3000
```

### 目录结构约定

```
/app
  /(legacy)          # 旧版 MVP 代码（只读，不再修改）
  /(lab)             # 实验性新功能
    /engine          # 新引擎沙盒页面
  /play              # 正式游戏路由
  /dashboard         # 用户 Dashboard
  /api               # API Routes
    /levels          # 关卡 CRUD
    /progress        # 进度保存
    /ai              # AI 代理
/components
  /engine            # 通用引擎组件
  /ui                # UI 基础组件
/lib
  /schema            # JSON Schema 定义
  /validation        # 验证引擎
/public
  /levels            # 临时存放 JSON（最终迁移到数据库）
```

---

## 结语

这份架构设计基于 **"最小化风险，最大化复用"** 的原则。我们不推倒重来，而是通过**绞杀榕模式**逐步演进。

关键成功因素：
1. **团队对齐**：工程师、产品、教研需要共同理解"产研解耦"的价值
2. **原型先行**：用 1-2 周快速验证新引擎可行性
3. **数据驱动决策**：通过 A/B 测试对比新旧引擎的用户体验

**下一步行动**：
- [ ] CTO 审核本文档
- [ ] 召开技术评审会议
- [ ] 启动 Week 1-2 的基础设施搭建

---

**文档作者**：Claude (AI 技术顾问)  
**审核者**：待指定  
**批准者**：待指定
