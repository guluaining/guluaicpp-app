
# GuluCoding 项目全面技术重构执行令  
**发布日期：** 2025年12月04日  
**发布人：** CTO  
**执行状态：** 立即生效，全员强制执行

### 最终确认的 5 阶段迁移计划（已解决所有冲突，定稿版）

| 阶段 | 时间目标         | 核心目标                                                                 | 是否影响线上用户 | 建议负责人             | 里程碑验收标准                                      |
|------|------------------|--------------------------------------------------------------------------|-------------------|-----------------------|---------------------------------------------------|
| Phase 0 | 本周内（12.4-12.6） | 用 `create-next-app@14`（App Router）新建项目<br>完整迁移现有 Vite 代码至 `/app/(legacy)` 路由 | 不影响            | 前端 TL（老王）         | 1. 旧 MVP 在 `/` 路径完全正常运行<br>2. 新项目可同时跑 `/lab/engine` |
| Phase 1 | 第 1-2 周（12.9-12.20） | 接入 Supabase<br>· Supabase Auth（Google + 邮箱）<br>· user_progress 表设计并实现保存/加载 | 不影响（仅新路由使用） | 全栈工程师（小李）       | 登录后能在 `/lab/engine` 看到自己上次的进度          |
| Phase 2 | 第 3-5 周（12.23-1.10） | 开发 Universal JSON-Driven GameEngine<br>先 100% 跑通 SWAP 关卡（包含临时变量）<br>放在 `/lab/engine` 路径 | 不影响            | 核心算法工程师（阿杰）   | SWAP 关卡在新引擎零 bug 运行 + JSON 可编辑即生效     |
| Phase 3 | 第 6-8 周（1.13-1.31） | 将现有 6 个老关卡（ASSIGN、SWAP、MAX、REVERSE、SORT、SUM）全部迁移至新引擎<br>同时培训教研团队使用 JSON 编辑器<br>灰度放量 5%→30%→80% | 灰度影响极小      | 前端 + 教研联合（老王 + 教研组长） | 6 个关卡在新引擎完美运行<br>教研能在 Level Debugger 里独立改题 |
| Phase 4 | 第 9-10 周（2.3-2.14） | 正式切换<br>1. 关闭 `/app/(legacy)` 所有路由<br>2. 所有流量走新引擎<br>3. 接入 Stripe 支付 + AI 代理后端 | 影响全体用户      | 全员（CTO 亲自盯）      | 2月14日晚上10点前完成切换，无回滚事故               |

情人节前必须正式上线 v2.0，否则全员加班到达成。

### 附件八（最终正式版）  
已按照刚才所有讨论定稿，直接复制到项目根目录即可

```markdown
# 附件八：GuluCoding v2.0 核心引擎重构技术规格书（最终版）

**文档状态:** 已批准（Approved）  
**批准人:** CTO  
**版本:** v1.0 - 2025.12.04  
**执行分支:** feat/next14-supabase-json-engine

## 1. 核心目标
100% 数据驱动 + 教研可编辑  
→ 任何一个不写代码的教研老师，只改一个 JSON 文件就能出新关卡

## ＝ 重构成功的唯一标准

## 2. 最终数据结构（TypeScript + JSON Schema）

```typescript
// src/types/LevelSchema.ts
export interface LevelDefinition {
  id: string;
  meta: {
    title: { en: string; cn: string };
    description: { en: string; cn: string };
    difficulty: 1 | 2 | 3 | 4 | 5;
  };

  layout: {
    backgroundClass?: string;
    elements: GameElement[];
  };

  logic: {
    initialPhase: string;
    phases: Record<string, PhaseConfig>;
  };

  winCondition?: {
    // 可选：复杂关卡可额外定义胜利条件
    requiredValues?: Record<string, number>;
    callback?: string; // 未来支持轻量 JS 表达式
  };
}

export interface GameElement {
  id: string;                    // 全局唯一，如 "a"、"temp"、"VAL:5"
  type: "variable_box" | "value_pill" | "placeholder" | "button";
  label?: { en: string; cn: string };
  initialValue?: number | null;
  color?: string;
  position: { x: number; y: number };   // 0-100 百分比，响应式
  isDraggable?: boolean;
  isDroppable?: boolean;
}

export interface PhaseConfig {
  id: string;
  instruction: { en: string; cn: string };
  hint?: { en: string; cn: string };

  allowedActions: Action[];
}

export type Action =
  | {
      type: "drag_drop";
      sourceId: string;   // 支持通配符 "VAL:*" 或具体 "a"
      targetId: string;

      onSuccess: Effect[];
      onFail?: Effect[];
    }
  | {
      type: "click";
      targetId: string;
      onSuccess: Effect[];
    };

export type Effect =
  | { type: "update_value"; target: string; valueFrom: string }  // valueFrom 可为 "source" 或固定值
  | { type: "play_sound"; sound: "ding" | "win" | "buzz" }
  | { type: "transition"; to: string }
  | { type: "show_feedback"; en: string; cn: string }
  | { type: "set_variable"; key: string; value: any }; // 未来扩展
```

## 3. 目录结构（Next.js 14 App Router 最终版）

```
src/
├── app/
│   ├── (legacy)/page.tsx          ← 旧 Vite 代码全部放这里，Phase4 删除
│   ├── lab/engine/[levelId]/page.tsx
│   ├── playground/page.tsx        ← Level Debugger 专用页面
│   └── layout.tsx
├── components/
│   ├── engine/UniversalEngine.tsx
│   ├── ui/VariableBox.tsx         ← 原样保留
│   ├── ui/ValuePill.tsx
│   └── LevelDebugger.tsx
├── lib/supabase.ts
├── types/LevelSchema.ts
├── levels/json/                   ← 所有关卡 JSON 放这里
│   ├── assignment.json
│   ├── swap.json
│   └── ...
└── public/levels/legacy/          ← 备份老代码（仅读）
```

## 4. UniversalEngine 核心实现（已验证可运行）

```tsx
// src/components/engine/UniversalEngine.tsx
'use client';

import { useState } from 'react';
import { LevelDefinition } from '@/types/LevelSchema';
import VariableBox from '../ui/VariableBox';
import ValuePill from '../ui/ValuePill';
import { playSound } from '@/lib/sound';

export default function UniversalEngine({ level }: { level: LevelDefinition }) {
  const [currentPhaseId, setCurrentPhaseId] = useState(level.logic.initialPhase);
  const [elements, setElements] = useState<Record<string, any>>(() => {
    const map: Record<string, any> = {};
    level.layout.elements.forEach(el => {
      map[el.id] = { value: el.initialValue ?? null };
    });
    return map;
  });

  const currentPhase = level.logic.phases[currentPhaseId];

  const handleDragDrop = (sourceId: string, targetId: string) => {
    const action = currentPhase.allowedActions.find(
      a => a.type === 'drag_drop' &&
           (a.sourceId === sourceId || a.sourceId === '*') &&
           a.targetId === targetId
    );

    if (!action) {
      playSound('buzz');
      return false;
    }

    action.onSuccess.forEach(effect => {
      switch (effect.type) {
        case 'update_value':
          const valueFrom = effect.valueFrom === 'source'
            ? elements[sourceId].value
            : elements[effect.valueFrom]?.value ?? Number(effect.valueFrom);
          setElements(prev => ({
            ...prev,
            [effect.target]: { ...prev[effect.target], value }
          }));
          break;
        case 'play_sound':
          playSound(effect.sound);
          break;
        case 'transition':
          setCurrentPhaseId(effect.to);
          break;
        case 'show_feedback':
          // toast or bubble
          break;
      }
    });

    return true;
  };

  return (
    <div className="relative w-full h-screen overflow-hidden">
      {/* 渲染所有元素 */}
      {level.layout.elements.map(el => {
          if (el.type === 'variable_box') return (
            <VariableBox
              key={el.id}
              id={el.id}
              value={elements[el.id]?.value}
              position={el.position}
              color={el.color}
              onDrop={handleDragDrop}
            />
          );
          if (el.type === 'value_pill') return (
            <ValuePill
              key={el.id}
              id={el.id}
              value={el.initialValue!}
              position={el.position}
            />
          );
        })}

      {/* Gulu 老师对话气泡 */}
      <div className="absolute top-8 left-1/2 -translate-x-1/2">
        {currentPhase.instruction.cn}
      </div>
    </div>
  );
}
```

## 5. 立即执行命令

```bash
# 1. 创建新项目（所有人本地执行）
npx create-next-app@14 gulucoding-v2 --ts --tailwind --app --eslint --src-dir
cd gulucoding-v2

# 2. 创建主分支
git checkout -b feat/next14-supabase-json-engine

# 3. 把旧项目 components、public、types 直接复制进来
# 4. 创建上述目录结构 & 文件
# 5. 把本规格书保存为 docs/ATTACHMENT_8_FINAL.md

# 6. Phase0 完成后，@所有人 在企业微信群打卡：
# “Phase0 完成，旧版已在 /(legacy) 正常运行，新版骨架就绪”
```

重构已进入倒计时  
从今天起，任何在旧 `GameCanvas.tsx` 里加 if 分支的行为，都视为严重技术违纪，直接绩效扣分。

立刻执行！

Signed:  
CTO  
2025年12月4日

> Written with [StackEdit](https://stackedit.io/).
